service: backend

plugins:
  - serverless-plugin-include-dependencies
  - serverless-offline

provider:
  name: aws
  runtime: nodejs10.x
  deploymentBucket:
    name: ${file(./config.json):S3_bucketName}
  deploymentPrefix: bicibici
  environment:
    TABLE_BIKES: ${file(./config.json):DB_Bikes}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: 
        - {"Fn::GetAtt": ["BikeDynamoDBTable", "Arn" ]}


functions:
  verificar_movimiento_bicicleta:
    handler: bicycleFunctions/verificar_movimiento.verificar_movimiento
    events:
      - iot:
          name: ${file(./config.json):IoT_Name}
          sql: ${file(./config.json):IoT_topic}
          description: ${file(./config.json):IoT_Description}
          enabled: true
          sqlVersion: ${file(./config.json):IoT_Version}

resources:
  Resources:
    BikeDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          -
            AttributeName: BicycleID
            AttributeType: N
        KeySchema:
          -
            AttributeName: BicycleID
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:provider.environment.TABLE_BIKES}
