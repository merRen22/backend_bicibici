service: backend

plugins:
  - serverless-plugin-include-dependencies
  - serverless-offline

provider:
  name: aws
  runtime: nodejs10.x
  deploymentBucket:
    name: ${file(./config.json):S3_bucketName}
  deploymentPrefix: bicibici
  environment:
    TABLE_BIKES: ${file(./config.json):DB_Bikes}
    TABLE_PLANS: ${file(./config.json):DB_Plans}
    TABLE_STATIONS: ${file(./config.json):DB_Stations}
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
      Resource: 
        - {"Fn::GetAtt": ["BikeDynamoDBTable", "Arn"],}
        - {"Fn::GetAtt": ["PlansDynamoDBTable", "Arn"],}
        - {"Fn::GetAtt": ["StationsDynamoDBTable", "Arn"],}
        
functions:
  verificar_movimiento_bicicleta:
    handler: bicycleFunctions/verificar_movimiento.verificar_movimiento
    events:
      - iot:
          name: ${file(./config.json):IoT_Name}
          sql: ${file(./config.json):IoT_topic}
          description: ${file(./config.json):IoT_Description}
          enabled: true
          sqlVersion: ${file(./config.json):IoT_Version}
  
  obtener_planes_usuarios:
    handler: userFunctions/obtener_planes.obtener_planes
    events:
      - http: ANY /
      - http: ANY {proxy+}
  
  obtener_informacion_estaciones:
    handler: userFunctions/informacion_estaciones.informacion_estaciones
    events:
      - http: ANY /
      - http: ANY {proxy+}

resources:
  Resources:
    BikeDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          -
            AttributeName: BicycleID
            AttributeType: N
        KeySchema:
          -
            AttributeName: BicycleID
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:provider.environment.TABLE_BIKES}
    
    PlansDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          -
            AttributeName: PlanID
            AttributeType: N
        KeySchema:
          -
            AttributeName: PlanID
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:provider.environment.TABLE_PLANS}
    
    StationsDynamoDBTable:
      Type: 'AWS::DynamoDB::Table'
      DeletionPolicy: Delete
      Properties:
        AttributeDefinitions:
          -
            AttributeName: StationID
            AttributeType: N
        KeySchema:
          -
            AttributeName: StationID
            KeyType: HASH
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        TableName: ${self:provider.environment.TABLE_STATIONS}
